---
- name: add apt repository key
  become: true
  apt_key:
    id: ACCC4CF8
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc

- name: add postgresql official apt repository
  become: true
  apt_repository:
    repo: deb http://apt.postgresql.org/pub/repos/apt/ {{ansible_distribution_release}}-pgdg main

- name: install postgres
  become: true
  apt:
    name: "{{item}}"
    state: present
    update_cache: true
  with_items:
    - libpq-dev
    - postgresql-{{postgres_version}}
    - postgresql-contrib-{{postgres_version}}

- name: install psycopg2 for ansible postgresql_user module
  become: true
  apt:
    name: "{{item}}"
    state: latest
  with_items:
    - python3-psycopg2

- name: configure authentication
  become: true
  template:
    src: pg_hba.conf
    dest: "{{postgres_hba_file}}"
    owner: root
    group: root
    mode: "0644"

- name: restart postgres
  become: true
  service:
    name: postgresql
    state: restarted

- name: create db user
  become: true
  become_user: "{{postgresql_admin_user}}"
  postgresql_user:
    name: "{{postgres_user}}"
    password: "{{postgres_password}}"
    state: present
    role_attr_flags: SUPERUSER,CREATEDB,LOGIN

- set_fact:
    postgres_db_name: "{{app_name}}_production"

- name: create database
  become: true
  become_user: "{{postgresql_admin_user}}"
  postgresql_db:
    name: "{{postgres_db_name}}"
    state: present
    owner: "{{postgres_user}}"

- name: grant privileges
  become: true
  become_user: "{{postgresql_admin_user}}"
  postgresql_privs:
    database: "{{postgres_db_name}}"
    state: present
    privs: ALL
    type: table
    objs: ALL_IN_SCHEMA
    schema: public
    roles: "{{postgres_user}}"
    grant_option: true

- name: create extensions
  become: true
  become_user: "{{postgresql_admin_user}}"
  postgresql_ext:
    name: "{{item}}"
    db: "{{postgres_db_name}}"
    state: present
  with_items: "{{postgres_extensions}}"
  when: "{{postgres_extensions}}"

- name: install pip3 for for ansible pip module
  become: true
  apt:
    name: "{{item}}"
    state: latest
  with_items:
    - python3-pip

- name: install pgcli
  become: true
  pip:
    name: pgcli
